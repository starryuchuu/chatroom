# 简易聊天程序项目说明

## 一、项目概述
本项目实现了一个简易聊天程序，包括服务端和客户端两个部分。  
- **服务端（server.py）**：负责处理用户注册、登录、聊天记录存储、好友申请及群聊/私聊消息转发。  
- **客户端（client.py）**：基于 Tkinter 构建图形界面，实现用户登录、注册、发送消息、接收消息以及好友管理等功能。

## 二、开发环境要求
- Python 版本：推荐使用 Python 3.7 或以上。
- 依赖模块：
  - socket、threading、datetime、sqlite3、hashlib、logging（Python 内置模块）
  - struct（用于构造定长的消息包，帮助实现带长度前缀的消息传输）
  - [pycryptodome](https://pycryptodome.readthedocs.io/)（用于 AES 加密解密，请使用 `pip install pycryptodome` 安装）
  - Tkinter（通常已随 Python 安装，如果不存在请自行安装）

## 三、项目目录结构
项目目录结构如下：
```
c:\Users\Master\Documents\chat_program_branch\
│
├── server.py         # 服务端程序代码，负责处理网络连接、用户认证、消息存储等
├── client.py         # 客户端程序代码，基于 Tkinter 构建用户图形界面
└── README.md         # 项目说明文件（本文件）
```

## 四、代码说明
### 4.1 server.py
- **功能说明**：
  - 使用 socket 实现 TCP 网络通信，监听指定端口等待客户端连接。
  - 使用 threading 建立多线程分别处理每个客户端请求。
  - 使用 SQLite 数据库存储用户信息、聊天记录以及好友关系。
  - 实现 AES 对消息的加密和解密，保证聊天过程中数据传输安全。
- **主要函数说明**：
  - `recvall`、`send_msg`、`recv_msg`：辅助函数，基于长度前缀实现消息的完整接收和发送。
  - `encrypt_message`、`decrypt_message`：对消息进行 AES 加密解密，并借助 Base64 传输编码。
  - `init_db`：初始化 SQLite 数据库，创建用户、消息和好友关系表。
  - `handle_client`：为每个客户端创建独立线程，完成注册、登录、消息转发及好友管理等功能。
  - `main`：服务器主入口，循环等待客户端请求。

### 4.2 client.py
- **功能说明**：
  - 基于 Tkinter 实现图形化用户界面，提供登录、注册界面及聊天窗口。
  - 使用 socket 建立与服务端的 TCP 连接，支持发送和接收加密消息。
  - 提供好友申请、好友响应、在线用户显示、群聊与私聊功能。
- **主要函数说明**：
  - `build_login`：构造登录界面，用户输入用户名和密码后点击“登录”或“注册”按钮。
  - `build_chat`：构造主聊天界面，分为好友列表、在线用户、消息显示区及消息输入区。
  - `send_msg` 和 `receive_msg`：负责消息的发送、加密以及接收、解密操作。
  - `handle_friend_request` 与 `handle_friend_response`：管理好友申请与响应功能。

## 五、运行说明
### 5.1 启动服务端
1. 打开命令提示符或终端进入项目目录。
2. 运行命令：
   ```
   python server.py
   ```
3. 服务器启动后会在终端输出相关日志记录，等待客户端连接。

### 5.2 启动客户端
1. 在另一命令提示符或终端中进入项目目录。
2. 运行命令：
   ```
   python client.py
   ```
3. 客户端程序会弹出窗口，首先显示登录界面。输入用户名和密码后点击登录进行身份认证；如果还没有账号，可以点击“注册”按钮进行注册。

## 六、注意事项
- **防止重复登录**：服务端在登录时会检查用户是否已经在线，防止同一账号多处登录。
- **加密传输**：所有消息在传输过程中均经过 AES 加密处理，保证数据在网络传输过程中的安全性。
- **数据库文件**：程序默认在当前目录生成或使用名为 `chat.db` 的 SQLite 数据库文件，请确保程序有读写权限。
- **日志管理**：程序在运行过程中会记录详细日志信息，便于调试和排查问题。

## 七、开发建议
- 阅读代码内的详细注释，了解每个函数和模块的作用。
- 如需扩展功能（例如添加文件传输、表情支持等），可以在现有的代码基础上进行修改和扩充。

## 八、常见问题
- **服务端未启动或端口被占用**：检查是否有其他程序占用了相同端口，或尝试更换端口号。
- **客户端连接失败**：请确认服务端已经正常启动且网络连接正常，检查 SERVER_HOST 和 SERVER_PORT 的配置是否正确。
- **数据库连接错误**：确保项目目录有写权限，或者检查 SQLite3 安装是否正常。

欢迎大家根据需要修改和扩展此项目，使其更加完善和符合自己的需求！
